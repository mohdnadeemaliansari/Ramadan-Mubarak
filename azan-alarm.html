<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azan Alarm</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-star-and-crescent"></i> Ramadan Blessings
            </a>
        </div>
    </nav>

    <!-- Azan Alarm Section -->
    <section class="container my-5">
        <h2><i class="fas fa-bell"></i> Online Azan Alarm (‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§Ö‡§ú‡§º‡§æ‡§® ‡§Ö‡§≤‡§æ‡§∞‡•ç‡§Æ)</h2>

        <p>
            Get online prayer timings and set Azan alarm easily. When prayer time comes, your Azan audio will play.
        </p>

        <p>
            ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§®‡§Æ‡§æ‡§ú‡§º ‡§ï‡•á ‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§∏‡§æ‡§®‡•Ä ‡§∏‡•á ‡§Ö‡§ú‡§º‡§æ‡§® ‡§Ö‡§≤‡§æ‡§∞‡•ç‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§ú‡§¨ ‡§®‡§Æ‡§æ‡§ú‡§º ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§π‡•ã‡§ó‡§æ ‡§§‡•ã ‡§Ö‡§ú‡§º‡§æ‡§® ‡§¨‡§ú‡•á‡§ó‡•Ä‡•§
        </p>

        <div class="card shadow p-4">

            <h4 class="text-success fw-bold mb-3">
                <i class="fas fa-globe"></i> Get Prayer Timings Online
            </h4>

            <label><b>Enter City:</b></label>
            <input type="text" class="form-control" id="cityName" placeholder="Example: Delhi">

            <label class="mt-3"><b>Enter Country:</b></label>
            <input type="text" class="form-control" id="countryName" placeholder="Example: India">

            <button class="btn btn-islamic mt-3 w-100" onclick="fetchPrayerTimes()">
                <i class="fas fa-clock"></i> Get Online Prayer Timings
            </button>

            <div class="table-responsive mt-4">
                <table class="table table-striped table-bordered text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Prayer</th>
                            <th>Time</th>
                            <th>Set Alarm</th>
                        </tr>
                    </thead>
                    <tbody id="prayerTable">
                        <tr>
                            <td colspan="3">No timings loaded yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="alert alert-success mt-4 text-center">
                <b>Alarm Status:</b>
                <p id="alarmStatus" class="m-0">No alarm set</p>
            </div>

            <div class="countdown-box mt-4">
                <h3>Countdown</h3>
                <p id="alarmCountdown">--:--:--</p>
            </div>

            <button class="btn btn-danger mt-3 w-100" onclick="stopAzanAlarm()">
                <i class="fas fa-stop"></i> Stop Alarm
            </button>

        </div>

        <!-- Audio File -->
        <audio id="azanAudio">
            <source src="azan.mp3" type="audio/mpeg">
        </audio>

        <a href="index.html" class="btn btn-islamic mt-4">
            <i class="fas fa-home"></i> Back to Home
        </a>

    </section>

    <!-- JavaScript -->
    <script>
        // ======================================
        // ONLINE PRAYER TIME FETCH (ALADHAN API)
        // ======================================

        async function fetchPrayerTimes() {
            const city = document.getElementById("cityName").value;
            const country = document.getElementById("countryName").value;

            if (city.trim() === "" || country.trim() === "") {
                alert("Please enter City and Country!");
                return;
            }

            try {
                const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=2`;

                const response = await fetch(url);
                const data = await response.json();

                const timings = data.data.timings;

                const prayerTimes = {
                    Fajr: timings.Fajr,
                    Dhuhr: timings.Dhuhr,
                    Asr: timings.Asr,
                    Maghrib: timings.Maghrib,
                    Isha: timings.Isha
                };

                let tableHTML = "";

                for (let prayer in prayerTimes) {
                    tableHTML += `
                        <tr>
                            <td><b>${prayer}</b></td>
                            <td>${prayerTimes[prayer]}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="setOnlineAlarm('${prayer}', '${prayerTimes[prayer]}')">
                                    Set Alarm
                                </button>
                            </td>
                        </tr>
                    `;
                }

                document.getElementById("prayerTable").innerHTML = tableHTML;

            } catch (error) {
                alert("Error fetching prayer timings. Please check city/country name.");
                console.log(error);
            }
        }

        // ======================================
        // SET ALARM USING ONLINE PRAYER TIME
        // ======================================

        let alarmInterval;

        function setOnlineAlarm(prayer, time) {
            document.getElementById("alarmStatus").innerText =
                `Alarm set for ${prayer} at ${time}`;

            localStorage.setItem("azanAlarmPrayer", prayer);
            localStorage.setItem("azanAlarmTime", time);

            if (alarmInterval) clearInterval(alarmInterval);

            alarmInterval = setInterval(() => {
                checkAzanAlarm(prayer, time);
                updateCountdown(time);
            }, 1000);

            alert(`Alarm set for ${prayer} at ${time}`);
        }

        // ======================================
        // CHECK ALARM
        // ======================================

        function checkAzanAlarm(prayer, alarmTime) {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);

            if (currentTime === alarmTime) {
                const audio = document.getElementById("azanAudio");

                if (audio) {
                    audio.play();
                }

                alert(`üïå Azan Time for ${prayer}!`);

                clearInterval(alarmInterval);
            }
        }

        // ======================================
        // STOP ALARM
        // ======================================

        function stopAzanAlarm() {
            const audio = document.getElementById("azanAudio");
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }

            if (alarmInterval) clearInterval(alarmInterval);

            document.getElementById("alarmStatus").innerText = "Alarm stopped";
            document.getElementById("alarmCountdown").innerText = "--:--:--";

            localStorage.removeItem("azanAlarmPrayer");
            localStorage.removeItem("azanAlarmTime");
        }

        // ======================================
        // COUNTDOWN TIMER
        // ======================================

        function updateCountdown(alarmTime) {
            const countdownElement = document.getElementById("alarmCountdown");
            if (!countdownElement) return;

            const now = new Date();
            const [hours, minutes] = alarmTime.split(":");

            let alarmDate = new Date();
            alarmDate.setHours(hours, minutes, 0);

            if (alarmDate < now) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }

            const diff = alarmDate - now;

            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            countdownElement.innerText = `${h}h ${m}m ${s}s`;
        }

        // ======================================
        // LOAD SAVED ALARM ON PAGE RELOAD
        // ======================================

        window.addEventListener("load", () => {
            const prayer = localStorage.getItem("azanAlarmPrayer");
            const time = localStorage.getItem("azanAlarmTime");

            if (prayer && time) {
                const status = document.getElementById("alarmStatus");
                if (status) status.innerText = `Alarm set for ${prayer} at ${time}`;

                alarmInterval = setInterval(() => {
                    checkAzanAlarm(prayer, time);
                    updateCountdown(time);
                }, 1000);
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>
